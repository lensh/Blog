<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JS运行机制-Event Loop（事件循环） | 洛清寒前端进阶</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.3.0">
    
    
    <link rel="preload" href="/blog/assets/css/0.styles.bb0d65c1.css" as="style"><link rel="preload" href="/blog/assets/js/app.4d96c53e.js" as="script"><link rel="preload" href="/blog/assets/js/2.a9ec72d1.js" as="script"><link rel="preload" href="/blog/assets/js/47.d4622c57.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.77389835.js"><link rel="prefetch" href="/blog/assets/js/11.9a95e166.js"><link rel="prefetch" href="/blog/assets/js/12.1659776e.js"><link rel="prefetch" href="/blog/assets/js/13.9d80e6cc.js"><link rel="prefetch" href="/blog/assets/js/14.748c57c3.js"><link rel="prefetch" href="/blog/assets/js/15.02b2a8b6.js"><link rel="prefetch" href="/blog/assets/js/16.92afd781.js"><link rel="prefetch" href="/blog/assets/js/17.50cf4b4b.js"><link rel="prefetch" href="/blog/assets/js/18.0353da46.js"><link rel="prefetch" href="/blog/assets/js/19.99e2bd93.js"><link rel="prefetch" href="/blog/assets/js/20.dcf807d4.js"><link rel="prefetch" href="/blog/assets/js/21.5f10ff5f.js"><link rel="prefetch" href="/blog/assets/js/22.10e9adeb.js"><link rel="prefetch" href="/blog/assets/js/23.4cb9121c.js"><link rel="prefetch" href="/blog/assets/js/24.dfd2d0ea.js"><link rel="prefetch" href="/blog/assets/js/25.f8792229.js"><link rel="prefetch" href="/blog/assets/js/26.161a0d2f.js"><link rel="prefetch" href="/blog/assets/js/27.609ca2bd.js"><link rel="prefetch" href="/blog/assets/js/28.74fafcba.js"><link rel="prefetch" href="/blog/assets/js/29.182d9bd2.js"><link rel="prefetch" href="/blog/assets/js/3.62b67fc4.js"><link rel="prefetch" href="/blog/assets/js/30.57dd1350.js"><link rel="prefetch" href="/blog/assets/js/31.49600992.js"><link rel="prefetch" href="/blog/assets/js/32.7381e84e.js"><link rel="prefetch" href="/blog/assets/js/33.cb0e280b.js"><link rel="prefetch" href="/blog/assets/js/34.10983cae.js"><link rel="prefetch" href="/blog/assets/js/35.efbdbc21.js"><link rel="prefetch" href="/blog/assets/js/36.1e5e4a19.js"><link rel="prefetch" href="/blog/assets/js/37.93097d3d.js"><link rel="prefetch" href="/blog/assets/js/38.3a942093.js"><link rel="prefetch" href="/blog/assets/js/39.7cc7a537.js"><link rel="prefetch" href="/blog/assets/js/4.13e4e37b.js"><link rel="prefetch" href="/blog/assets/js/40.609cfb28.js"><link rel="prefetch" href="/blog/assets/js/41.7c3e849f.js"><link rel="prefetch" href="/blog/assets/js/42.81422964.js"><link rel="prefetch" href="/blog/assets/js/43.335a6518.js"><link rel="prefetch" href="/blog/assets/js/44.754b4fab.js"><link rel="prefetch" href="/blog/assets/js/45.64447c20.js"><link rel="prefetch" href="/blog/assets/js/46.803d5f0c.js"><link rel="prefetch" href="/blog/assets/js/48.96ca283d.js"><link rel="prefetch" href="/blog/assets/js/49.63042edb.js"><link rel="prefetch" href="/blog/assets/js/5.33237216.js"><link rel="prefetch" href="/blog/assets/js/50.708578f1.js"><link rel="prefetch" href="/blog/assets/js/51.92207ff7.js"><link rel="prefetch" href="/blog/assets/js/52.d4a8bd9d.js"><link rel="prefetch" href="/blog/assets/js/53.24bead76.js"><link rel="prefetch" href="/blog/assets/js/54.5d5c0c91.js"><link rel="prefetch" href="/blog/assets/js/55.636e684f.js"><link rel="prefetch" href="/blog/assets/js/56.c3cd471d.js"><link rel="prefetch" href="/blog/assets/js/57.4ccc03b2.js"><link rel="prefetch" href="/blog/assets/js/58.ab320273.js"><link rel="prefetch" href="/blog/assets/js/59.d9d12af6.js"><link rel="prefetch" href="/blog/assets/js/6.14f0c0ef.js"><link rel="prefetch" href="/blog/assets/js/60.2d07b7f0.js"><link rel="prefetch" href="/blog/assets/js/61.fdbd3c09.js"><link rel="prefetch" href="/blog/assets/js/62.f0f1105b.js"><link rel="prefetch" href="/blog/assets/js/63.efec7adb.js"><link rel="prefetch" href="/blog/assets/js/64.65f1fde6.js"><link rel="prefetch" href="/blog/assets/js/65.c02b230a.js"><link rel="prefetch" href="/blog/assets/js/7.c6e553de.js"><link rel="prefetch" href="/blog/assets/js/8.67965e6b.js"><link rel="prefetch" href="/blog/assets/js/9.743d0d51.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.bb0d65c1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/images/blog.jpg" alt="洛清寒前端进阶" class="logo"> <span class="site-name can-hide">洛清寒前端进阶</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/blog/" class="nav-link">
  进阶博文
</a></div><div class="nav-item"><a href="/blog/interview/" class="nav-link router-link-active">
  笔试面试
</a></div><div class="nav-item"><a href="https://juejin.im/post/5dfef50751882512444027eb" target="_blank" rel="noopener noreferrer" class="nav-link external">
  大厂面经
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Github" class="dropdown-title"><span class="title">Github</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/lensh/vue-qq" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vue-qq
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/lensh/mini-promise" target="_blank" rel="noopener noreferrer" class="nav-link external">
  mini-promise
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/lensh/React-SSR" target="_blank" rel="noopener noreferrer" class="nav-link external">
  react-ssr
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/blog/" class="nav-link">
  进阶博文
</a></div><div class="nav-item"><a href="/blog/interview/" class="nav-link router-link-active">
  笔试面试
</a></div><div class="nav-item"><a href="https://juejin.im/post/5dfef50751882512444027eb" target="_blank" rel="noopener noreferrer" class="nav-link external">
  大厂面经
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Github" class="dropdown-title"><span class="title">Github</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/lensh/vue-qq" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vue-qq
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/lensh/mini-promise" target="_blank" rel="noopener noreferrer" class="nav-link external">
  mini-promise
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://github.com/lensh/React-SSR" target="_blank" rel="noopener noreferrer" class="nav-link external">
  react-ssr
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/blog/interview/css/1.html" class="sidebar-heading clickable"><span>css</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/interview/es6/1.html" class="sidebar-heading clickable"><span>es6</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/interview/html/1.html" class="sidebar-heading clickable"><span>html</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/interview/js/1.html" class="sidebar-heading clickable open"><span>js</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/interview/js/1.html" class="sidebar-link">面向对象和原型链</a></li><li><a href="/blog/interview/js/2.html" class="active sidebar-link">JS运行机制-Event Loop（事件循环）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/interview/js/2.html#一、为什么javascript是单线程？" class="sidebar-link">一、为什么JavaScript是单线程？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/interview/js/2.html#进程和线程" class="sidebar-link">进程和线程</a></li></ul></li><li class="sidebar-sub-header"><a href="/blog/interview/js/2.html#二、事件循环-event-loop" class="sidebar-link">二、事件循环(Event Loop)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/interview/js/2.html#关于settimeout" class="sidebar-link">关于setTimeout</a></li><li class="sidebar-sub-header"><a href="/blog/interview/js/2.html#关于setinterval" class="sidebar-link">关于setInterval</a></li><li class="sidebar-sub-header"><a href="/blog/interview/js/2.html#promise与process-nexttick-callback" class="sidebar-link">Promise与process.nextTick(callback)</a></li><li class="sidebar-sub-header"><a href="/blog/interview/js/2.html#关于async和await" class="sidebar-link">关于async和await</a></li><li class="sidebar-sub-header"><a href="/blog/interview/js/2.html#浏览器相关线程" class="sidebar-link">浏览器相关线程</a></li><li class="sidebar-sub-header"><a href="/blog/interview/js/2.html#事件循环机制" class="sidebar-link">事件循环机制</a></li></ul></li></ul></li><li><a href="/blog/interview/js/3.html" class="sidebar-link">每隔一秒输出一个数字，从 0 - 5</a></li><li><a href="/blog/interview/js/4.html" class="sidebar-link">模块化</a></li><li><a href="/blog/interview/js/5.html" class="sidebar-link">防抖和节流</a></li><li><a href="/blog/interview/js/6.html" class="sidebar-link">数组扁平化和柯里化</a></li><li><a href="/blog/interview/js/7.html" class="sidebar-link">判断数组的方法</a></li><li><a href="/blog/interview/js/8.html" class="sidebar-link">面试题</a></li><li><a href="/blog/interview/js/9.html" class="sidebar-link">事件机制、事件模型、事件流</a></li><li><a href="/blog/interview/js/10.html" class="sidebar-link">前端监控</a></li><li><a href="/blog/interview/js/11.html" class="sidebar-link">同源策略、跨域</a></li><li><a href="/blog/interview/js/12.html" class="sidebar-link">防篡改对象</a></li><li><a href="/blog/interview/js/13.html" class="sidebar-link">深入Object.defineProperty</a></li><li><a href="/blog/interview/js/14.html" class="sidebar-link">getBoundingClientRect()</a></li><li><a href="/blog/interview/js/15.html" class="sidebar-link">变量提升和函数提升</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/interview/node/node.html" class="sidebar-heading clickable"><span>node</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/interview/react/react.html" class="sidebar-heading clickable"><span>react</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/interview/vue/vue.html" class="sidebar-heading clickable"><span>vue</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/interview/webpack/webpack.html" class="sidebar-heading clickable"><span>webpack</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/interview/browser/1.html" class="sidebar-heading clickable"><span>浏览器</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/interview/coding/coding.html" class="sidebar-heading clickable"><span>编程题</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/interview/interview/interview.html" class="sidebar-heading clickable"><span>面试题</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/interview/network/1.html" class="sidebar-heading clickable"><span>网络和网络安全</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/interview/practice-mode/practice-mode.html" class="sidebar-heading clickable"><span>设计模式</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/blog/interview/suanfa/suanfa.html" class="sidebar-heading clickable"><span>算法和数据结构</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="js运行机制-event-loop（事件循环）"><a href="#js运行机制-event-loop（事件循环）" class="header-anchor">#</a> JS运行机制-Event Loop（事件循环）</h1> <h2 id="一、为什么javascript是单线程？"><a href="#一、为什么javascript是单线程？" class="header-anchor">#</a> 一、为什么JavaScript是单线程？</h2> <p>单线程：同一个时间只能做一件事。为什么是单线程？</p> <p>因为在 JS 运行的时候可能会阻止 UI 渲染，这说明了两个线程是互斥的。这其中的原因是因为 JS 可以修改 DOM，如果在 JS 执行的时候 UI 线程还在工作，就可能导致不能安全的渲染 UI。</p> <p>为了利用多核CPU的计算能力，HTML5提出Web Worker标准，允许JavaScript脚本创建多个线程，但是子线程完全受主线程控制，且不得操作DOM。所以，这个新标准并没有改变JavaScript单线程的本质。</p> <h3 id="进程和线程"><a href="#进程和线程" class="header-anchor">#</a> 进程和线程</h3> <p>本质上来说，两个名词都是 CPU 工作时间片的一个描述。</p> <p>进程描述了 CPU 在运行指令及加载和保存上下文所需的时间，放在应用上来说就代表了一个程序。线程是进程中的更小单位，描述了执行一段指令所需的时间。</p> <p>当打开一个 Tab 页时，其实就是创建了一个进程，一个进程中可以有多个线程，比如渲染线程、JS 引擎线程、HTTP 请求线程等等。当你发起一个请求时，其实就是创建了一个线程，当请求结束后，该线程可能就会被销毁。</p> <h2 id="二、事件循环-event-loop"><a href="#二、事件循环-event-loop" class="header-anchor">#</a> 二、事件循环(Event Loop)</h2> <p>当我们打开网站时，网页的渲染过程就是一大堆同步任务，比如页面骨架和页面元素的渲染。而像加载图片音乐之类占用资源大耗时久的任务，就是异步任务。关于这部分有严格的文字定义，但本文的目的是用最小的学习成本彻底弄懂执行机制，所以我们用导图来说明：</p> <p><img src="https://user-gold-cdn.xitu.io/2017/11/21/15fdd88994142347?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image"></p> <p>导图要表达的内容用文字来表述的话：</p> <ul><li>同步和异步任务分别进入不同的执行&quot;场所&quot;，同步的进入主线程，异步的进入Event Table并注册函数。</li> <li>当指定的事情完成时，Event Table会将这个函数移入Event Queue。</li> <li>主线程内的任务执行完毕为空，会去Event Queue读取对应的函数，进入主线程执行。</li> <li>上述过程会不断重复，也就是常说的Event Loop(事件循环)。</li></ul> <p>主线程从”任务队列”中读取事件，这个过程是循环不断的，所以整个的这种运行机制又称为Event Loop（事件循环）。</p> <p>我们不禁要问了，那怎么知道主线程执行栈为空啊？js引擎存在monitoring process进程，会持续不断的检查主线程执行栈是否为空，一旦为空，就会去Event Queue那里检查是否有等待被调用的函数。</p> <p>下面是一段简易的ajax请求代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
$<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    url<span class="token operator">:</span>www<span class="token punctuation">.</span>javascript<span class="token punctuation">.</span>com<span class="token punctuation">,</span>
    data<span class="token operator">:</span>data<span class="token punctuation">,</span>
    <span class="token function-variable function">success</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发送成功!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'代码执行结束'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ajax进入Event Table，注册回调函数success。执行console.log('代码执行结束')。ajax事件完成，回调函数success进入Event Queue。主线程从Event Queue读取回调函数success并执行。</p> <h3 id="关于settimeout"><a href="#关于settimeout" class="header-anchor">#</a> 关于setTimeout</h3> <p>我们经常这么实现延时3秒执行：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'延时3秒'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>渐渐的setTimeout用的地方多了，问题也出现了，有时候明明写的延时3秒，实际却5，6秒才执行函数，这又咋回事啊？</p> <p>我们修改一下前面的代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>

<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">)</span>
</code></pre></div><p>乍一看其实差不多嘛，但我们把这段代码在chrome执行一下，却发现控制台执行task()需要的时间远远超过3秒，说好的延时三秒，为啥现在需要这么长时间啊？</p> <p>这时候我们需要重新理解setTimeout的定义。我们先说上述代码是怎么执行的：</p> <ul><li>task()进入Event Table并注册,计时开始。</li> <li>执行sleep函数，很慢，非常慢，计时仍在继续。</li> <li>3秒到了，计时事件timeout完成，task()进入Event Queue，但是sleep也太慢了吧，还没执行完，只好等着。</li> <li>sleep终于执行完了，task()终于从Event Queue进入了主线程执行。</li></ul> <p>上述的流程走完，我们知道setTimeout这个函数，是经过指定时间后，把要执行的任务(本例中为task())加入到Event Queue中，又因为是单线程任务要一个一个执行，如果前面的任务需要的时间太久，那么只能等着，导致真正的延迟时间远远大于3秒。</p> <p>setTimeout()只是将事件插入了”任务队列”，必须等到当前代码（执行栈）执行完，主线程才会去执行它指定的回调函数。要是当前代码耗时很长，有可能要等很久，所以并没有办法保证，回调函数一定会在setTimeout()指定的时间执行。</p> <p>我们还经常遇到setTimeout(fn,0)这样的代码，0秒后执行又是什么意思呢？是不是可以立即执行呢？
答案是不会的，setTimeout(fn,0)的含义是，指定某个任务在主线程最早可得的空闲时间执行，意思就是不用再等多少秒了，只要主线程执行栈内的同步任务全部执行完成，栈为空就马上执行。</p> <p>关于setTimeout要补充的是，即便主线程为空，0毫秒实际上也是达不到的。根据HTML的标准，最低是4毫秒。</p> <h3 id="关于setinterval"><a href="#关于setinterval" class="header-anchor">#</a> 关于setInterval</h3> <p>上面说完了setTimeout，当然不能错过它的孪生兄弟setInterval。他俩差不多，只不过后者是循环的执行。对于执行顺序来说，setInterval会每隔指定的时间将注册的函数置入Event Queue，如果前面的任务耗时太久，那么同样需要等待。
唯一需要注意的一点是，对于setInterval(fn,ms)来说，我们已经知道不是每过ms秒会执行一次fn，而是每过ms秒，会有fn进入Event Queue。一旦setInterval的回调函数fn执行时间超过了延迟时间ms，那么就完全看不出来有时间间隔了。</p> <h3 id="promise与process-nexttick-callback"><a href="#promise与process-nexttick-callback" class="header-anchor">#</a> Promise与process.nextTick(callback)</h3> <p>除了广义的同步任务和异步任务，我们对任务有更精细的定义：</p> <ul><li><p>macro-task(宏任务)：包括 script （主代码块）、setTimeout 、setInterval 、setImmediate 、I/O 、UI rendering</p></li> <li><p>micro-task(微任务)：Promise.then(非new Promise)，process.nextTick（node中）、Object.observe 、MutationObserver</p></li></ul> <p>在ES6中，microtask称为 jobs，macrotask称为 task。</p> <p>不同类型的任务会进入对应的Event Queue，比如setTimeout和setInterval会进入相同的Event Queue。</p> <p>事件循环的顺序，决定js代码的执行顺序。进入整体代 码(宏任务)后，开始第一次循环。接着执行所有的微任务。然后再次从宏任务开始，找到其中一个任务队列执行完毕，再执行所有的微任务。</p> <p>听起来有点绕，我们用文章最开始的一段代码说明：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'console'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>这段script代码作为宏任务，进入主线程。</li> <li>先遇到setTimeout，那么将其回调函数注册后分发到宏任务Event Queue。(注册过程与上同，下文不再描述)</li> <li>接下来遇到了Promise，new Promise立即执行，then函数分发到微任务Event Queue。</li> <li>遇到console.log()，立即执行。</li> <li>好啦，整体代码script作为第一个宏任务执行结束，看看有哪些微任务？我们发现了then在微任务Event Queue里面，执行。</li> <li>ok，第一轮事件循环结束了，我们开始第二轮循环，当然要从宏任务Event Queue开始。我们发现了宏任务Event Queue中setTimeout对应的回调函数，立即执行。</li> <li>结束。</li></ul> <p>事件循环，宏任务，微任务的关系如图所示：</p> <p><img src="https://user-gold-cdn.xitu.io/2017/11/21/15fdcea13361a1ec?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image"></p> <p>我们来分析一段较复杂的代码，看看你是否真的掌握了js的执行机制：</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'6'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'7'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'8'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'9'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'11'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'12'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>第一轮事件循环流程分析如下：</p> <ul><li>整体script作为第一个宏任务进入主线程，遇到console.log，输出1。</li> <li>遇到setTimeout，其回调函数被分发到宏任务Event Queue中。我们暂且记为setTimeout1。</li> <li>遇到process.nextTick()，其回调函数被分发到微任务Event Queue中。我们记为process1。</li> <li>遇到Promise，new Promise直接执行，输出7。then被分发到微任务Event Queue中。我们记为then1。</li> <li>又遇到了setTimeout，其回调函数被分发到宏任务Event Queue中，我们记为setTimeout2。</li></ul> <table><thead><tr><th>宏任务Event Queue</th> <th style="text-align:center;">微任务Event Queue</th></tr></thead> <tbody><tr><td>setTimeout1</td> <td style="text-align:center;">process1</td></tr> <tr><td>setTimeout2</td> <td style="text-align:center;">then1</td></tr></tbody></table> <ul><li><p>上表是第一轮事件循环宏任务结束时各Event Queue的情况，此时已经输出了1和7。</p></li> <li><p>我们发现了process1和then1两个微任务。</p></li> <li><p>执行process1,输出6。</p></li> <li><p>执行then1，输出8。</p></li></ul> <p>好了，第一轮事件循环正式结束，这一轮的结果是输出1，7，6，8。</p> <p>那么第二轮时间循环从setTimeout1宏任务开始：</p> <ul><li>首先输出2。接下来遇到了process.nextTick()，同样将其分发到微任务Event Queue中，记为process2。new Promise立即执行输出4，then也分发到微任务Event Queue中，记为then2。</li></ul> <table><thead><tr><th>宏任务Event Queue</th> <th style="text-align:center;">微任务Event Queue</th></tr></thead> <tbody><tr><td>setTimeout2</td> <td style="text-align:center;">process2</td></tr> <tr><td></td> <td style="text-align:center;">then2</td></tr></tbody></table> <ul><li>第二轮事件循环宏任务结束，我们发现有process2和then2两个微任务可以执行。</li> <li>输出3。</li> <li>输出5。</li> <li>第二轮事件循环结束，第二轮输出2，4，3，5。</li></ul> <p>第三轮事件循环开始，此时只剩setTimeout2了，执行。</p> <ul><li>直接输出9。</li> <li>将process.nextTick()分发到微任务Event Queue中。记为process3。</li> <li>直接执行new Promise，输出11。</li> <li>将then分发到微任务Event Queue中，记为then3。</li></ul> <table><thead><tr><th>宏任务Event Queue</th> <th style="text-align:center;">微任务Event Queue</th></tr></thead> <tbody><tr><td></td> <td style="text-align:center;">process3</td></tr> <tr><td></td> <td style="text-align:center;">then3</td></tr></tbody></table> <ul><li>第三轮事件循环宏任务执行结束，执行两个微任务process3和then3。</li> <li>输出10。</li> <li>输出12。</li> <li>第三轮事件循环结束，第三轮输出9，11，10，12。</li></ul> <p>整段代码，共进行了三次事件循环，完整的输出为1，7，6，8，2，4，3，5，9，11，10，12。
(请注意，node环境下的事件监听依赖libuv与前端环境不完全相同，输出顺序可能会有误差)</p> <h3 id="关于async和await"><a href="#关于async和await" class="header-anchor">#</a> 关于async和await</h3> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async2 end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise'</span><span class="token punctuation">)</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script end'</span><span class="token punctuation">)</span>
<span class="token comment">// script start =&gt; async2 end =&gt; Promise =&gt; script end =&gt; promise1 =&gt; promise2 =&gt; async1 end =&gt; setTimeout</span>
</code></pre></div><p>首先先来解释下上述代码的 async 和 await 的执行顺序。当我们调用 async1 函数时，会马上输出 async2 end，并且函数返回一个 Promise，接下来在遇到await的时候会就让出线程开始执行 async1 外的代码，所以我们完全可以把await看成是让出线程的标志。</p> <p>然后当同步代码全部执行完毕以后，就会去执行所有的异步代码，那么又会回到 await 的位置执行返回的 Promise 的 resolve 函数，这又会把 resolve 丢到微任务队列中，接下来去执行 then 中的回调，当两个 then 中的回调全部执行完毕以后，又会回到 await 的位置处理返回值，这时候你可以看成是 <code>Promise.resolve(返回值).then()</code>，然后 await 后的代码全部被包裹进了 then 的回调中，所以 <code>console.log('async1 end')</code>会优先执行于 setTimeout。</p> <p>如果你觉得上面这段解释还是有点绕，那么我把 async 的这两个函数改造成你一定能理解的代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async2 end'</span><span class="token punctuation">)</span>
  <span class="token comment">// Promise.resolve() 将代码插入微任务队列尾部</span>
  <span class="token comment">// resolve 再次插入微任务队列尾部</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>也就是说，如果 await 后面跟着 Promise 的话，async1 end 需要等待三个 tick 才能执行到。那么其实这个性能相对来说还是略慢的，所以 V8 团队借鉴了 Node 8 中的一个 Bug，在引擎底层将三次 tick 减少到了二次 tick。但是这种做法其实是违法了规范的，当然规范也是可以更改的，这是 V8 团队的一个 PR，目前已被同意这种做法。</p> <h3 id="浏览器相关线程"><a href="#浏览器相关线程" class="header-anchor">#</a> 浏览器相关线程</h3> <p>浏览器（多进程）包含了Browser进程（浏览器的主进程）、第三方插件进程和GPU进程（浏览器渲染进程），其中GPU进程（多线程）和Web前端密切相关，包含以下线程：</p> <ul><li>GUI渲染线程</li> <li>JS引擎线程</li> <li>事件触发线程（和EventLoop密切相关）</li> <li>定时触发器线程</li> <li>异步HTTP请求线程</li></ul> <p>GUI渲染线程和JS引擎线程是互斥的，为了防止DOM渲染的不一致性，其中一个线程执行时另一个线程会被挂起。</p> <p>这些线程中，和Vue的nextTick息息相关的是<strong>JS引擎线程</strong>和<strong>事件触发线程</strong>。</p> <p>浏览器页面初次渲染完毕后，JS引擎线程结合事件触发线程的工作流程如下：</p> <p>（1）同步任务在JS引擎线程（主线程）上执行，形成执行栈（Execution Context Stack）。</p> <p>（2）主线程之外，事件触发线程管理着一个任务队列（Task Queue）。只要异步任务有了运行结果，就在任务队列之中放置一个事件。</p> <p>（3）执行栈中的同步任务执行完毕，系统就会读取任务队列，如果有异步任务需要执行，将其加到主线程的执行栈并执行相应的异步任务。</p> <p>主线程的执行流程如下图所示：</p> <p><img src="https://user-gold-cdn.xitu.io/2019/5/13/16ab1b052294607c?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image"></p> <h3 id="事件循环机制"><a href="#事件循环机制" class="header-anchor">#</a> 事件循环机制</h3> <p>事件触发线程管理的任务队列是如何产生的呢？事实上这些任务就是从JS引擎线程本身产生的，主线程在运行时会产生执行栈，栈中的代码调用某些异步API时会在任务队列中添加事件，栈中的代码执行完毕后，就会读取任务队列中的事件，去执行事件对应的回调函数，如此循环往复，形成事件循环机制，如下图所示：</p> <p><img src="https://user-gold-cdn.xitu.io/2019/5/13/16ab1b0b9c0cbfa4?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="image"></p> <p>宏任务和微任务的区别：</p> <ul><li>宏任务是每次执行栈执行的代码（包括每次从事件队列中获取一个事件回调并放到执行栈中执行）</li> <li>浏览器为了能够使得JS引擎线程与GUI渲染线程有序切换，会在当前宏任务结束之后，下一个宏任务执行开始之前，对页面进行重新渲染（宏任务 &gt; 渲染  &gt; 宏任务 &gt; ...）</li> <li>微任务是在当前宏任务执行结束之后立即执行的任务（在当前 宏任务执行之后，UI渲染之前执行的任务）。微任务的响应速度相比setTimeout（下一个宏任务）会更快，因为无需等待UI渲染。</li> <li>当前宏任务执行后，会将在它执行期间产生的所有微任务都执行一遍。</li></ul> <p>根据事件循环机制，重新梳理一下流程：</p> <ul><li>执行一个宏任务（首次执行的主代码块或者任务队列中的回调函数）</li> <li>执行过程中如果遇到微任务，就将它添加到微任务的任务队列中</li> <li>宏任务执行完毕后，立即执行当前微任务队列中的所有任务（依次执行）</li> <li>JS引擎线程挂起，GUI线程执行渲染</li> <li>GUI线程渲染完毕后挂起，JS引擎线程执行任务队列中的下一个宏任务</li></ul> <p><a href="https://juejin.im/post/59e85eebf265da430d571f89#heading-0" target="_blank" rel="noopener noreferrer">参考<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/10/2020, 3:56:42 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/interview/js/1.html" class="prev">
        面向对象和原型链
      </a></span> <span class="next"><a href="/blog/interview/js/3.html">
        每隔一秒输出一个数字，从 0 - 5
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.4d96c53e.js" defer></script><script src="/blog/assets/js/2.a9ec72d1.js" defer></script><script src="/blog/assets/js/47.d4622c57.js" defer></script>
  </body>
</html>
